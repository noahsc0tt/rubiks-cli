#!/usr/bin/env ruby
require 'optparse'
require 'rubiks_cli'

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: rubiks [options]"

  opts.on("-c", "--clear", "Clear the screen before starting") do
    options[:clear] = true
  end

  opts.on("-i", "--inspection", "Include inspection time") do
    options[:inspection] = true
  end

  opts.on("-l", "--loop", "Loop forever") do
    options[:loop] = true
  end

  opts.on("-s", "--scramble", "Generate scramble") do
    options[:scramble] = true
  end

  opts.on("-t", "--time", "Start timer") do
    options[:time] = true
  end

end.parse!

if options.values.none?
  options[:scramble] = true
  options[:time] = true
end

RubiksCli::Clear.screen if options[:clear]

output_scramble = lambda { puts RubiksCli::Scrambler.get_scramble }
start_timer = lambda { RubiksCli::Timer.start(options[:inspection]) }
start_timer_then_output_scramble = lambda {
  RubiksCli::Timer.start(options[:inspection])
  puts "\n#{RubiksCli::Scrambler.get_scramble}"
}

if options[:loop]

  if options[:time] && options[:scramble]
    RubiksCli::Clear.screen
    RubiksCli::Loop.build(
      RubiksCli::Loop.create_action('', start_timer_then_output_scramble, "start solve"),
      [ RubiksCli::Loop.create_action('n', output_scramble, "generate new scramble"), ]
    ).start

  elsif options[:scramble]
    RubiksCli::Clear.screen
    RubiksCli::Loop.build(
      RubiksCli::Loop.create_action('', output_scramble, "generate a scramble"),
      [ RubiksCli::Loop.create_action('t', start_timer_then_output_scramble, "start timer"), ]
    ).start

  elsif options[:time]
    RubiksCli::Clear.screen
    RubiksCli::Loop.build(
      RubiksCli::Loop.create_action('', start_timer, "start timer"),
      [ RubiksCli::Loop.create_action('n', output_scramble, "generate a scramble"), ]
    ).start

  else
    puts "Invalid options for loop mode: must specify --time and/or --scramble"
  end
else
  if options[:time] && options[:scramble]
    output_scramble.call
    gets
    RubiksCli::Clear.line_above
    start_timer.call

  elsif options[:scramble]
    output_scramble.call

  elsif options[:time]
    start_timer.call

  else
  end

end
